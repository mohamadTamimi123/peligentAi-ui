name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  NODE_VERSION: '18'

jobs:
  # -----------------------
  # Build & Test Job
  # -----------------------
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
        
      - name: Install dependencies
        run: npm ci
      
      - name: Run linting
        run: npm run lint
      
      - name: Run type checking
        run: npm run type-check
      
      - name: Build application
        run: npm run build
      
      - name: Run tests (if available)
        run: npm test --if-present

  # -----------------------
  # Deploy Job
  # -----------------------
  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
             set -e
 
             APP_DIR=/home/dev/app/ui
             REPO_URL=https://github.com/Pariant/agent-ui.git
 
             # Ø§Ú¯Ø± repo ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ â†’ ÙÙ‚Ø· update Ú©Ù†
             if [ -d "$APP_DIR/.git" ]; then
               echo "âœ… Repository exists. Updating..."
               cd $APP_DIR
               git fetch origin
               if git rev-parse --verify origin/main >/dev/null 2>&1; then
                 git reset --hard origin/main
               else
                 git reset --hard origin/master
               fi
             else
               # Ø§Ú¯Ø± repo ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ â†’ Ú©Ù„ÙˆÙ† Ø¬Ø¯ÛŒØ¯ Ø¨Ú¯ÛŒØ±
               echo "âš ï¸ Repository does not exist. Cloning..."
               # Ø­Ø°Ù Ú©Ø§Ù…Ù„ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ù…ÙˆØ¬ÙˆØ¯
               rm -rf "$APP_DIR"
               mkdir -p /home/dev/app
               cd /home/dev/app
               git clone $REPO_URL ui
               cd $APP_DIR
             fi
 
             # Ù†ØµØ¨ Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ Ùˆ Ø¨ÛŒÙ„Ø¯
             npm ci
             npm run build
 
             # Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§ pm2
             if ! pm2 describe agent-ui >/dev/null 2>&1; then
               pm2 start npm --name "agent-ui" -- start
             else
               pm2 restart agent-ui
             fi
 
             pm2 save
             echo "ğŸš€ Deployment finished successfully"
